<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy & Production Analysis Tool</title>
    
    <!-- Icons for Modern UI -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Highcharts CSS for Styled Mode -->
    <link rel="stylesheet" href="https://code.highcharts.com/css/highcharts.css">
    <link rel="stylesheet" href="style.css">
    <!-- Highcharts Datagrid CSS -->
    <link rel="stylesheet" href="https://code.highcharts.com/datagrid/css/datagrid.css">

    <!-- Scripts -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/dashboards/dashboards.js"></script>
    <script src="https://code.highcharts.com/modules/sankey.js"></script>
    <script src="https://code.highcharts.com/modules/organization.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/dashboards/datagrid.js"></script>
    <script src="https://code.highcharts.com/modules/draggable-points.js"></script>
    <script src="https://code.highcharts.com/dashboards/modules/layout.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-statistics@7.8.3/dist/simple-statistics.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-statistics@7.8.3/dist/simple-statistics.min.js"></script>

</head>
<body>
    <div id="app-container">
        <!-- LEFT PANEL: SIDEBAR NAVIGATION & HIERARCHY -->
        <div id="sidebar">
            <div class="sidebar-header">
                <h2><i class="fa-solid fa-bolt"></i> EnergyTool</h2>
            </div>
            
            <div class="sidebar-section">
                <h3><i class="fa-solid fa-sitemap"></i> Energy Systems</h3>
                <div class="sidebar-controls">
                    <button id="add-root-btn" title="Add Root"><i class="fa-solid fa-plus"></i> Root</button>
                    <button id="add-child-btn" disabled title="Add Child"><i class="fa-solid fa-code-branch"></i> Child</button>
                    <button id="rename-node-btn" disabled title="Rename"><i class="fa-solid fa-pen"></i></button>
                    <button id="delete-node-btn" disabled title="Delete" class="btn-danger"><i class="fa-solid fa-trash"></i></button>
                </div>
                <div id="hierarchy-tree" class="tree-container"></div>
            </div>

            <div class="sidebar-section">
                <h3><i class="fa-solid fa-industry"></i> Production Lines</h3>
                <div class="sidebar-controls">
                    <button id="add-root-production-btn" title="Add Line"><i class="fa-solid fa-plus"></i> Root</button>
                    <button id="add-child-production-btn" disabled title="Add Child"><i class="fa-solid fa-code-branch"></i> Child</button>
                    <button id="rename-production-btn" disabled title="Rename"><i class="fa-solid fa-pen"></i></button>
                    <button id="delete-production-btn" disabled title="Delete" class="btn-danger"><i class="fa-solid fa-trash"></i></button>
                </div>
                <div id="production-tree" class="tree-container"></div>
            </div>

            <div class="sidebar-footer">
                <h3>Data & Setup</h3>
                <div class="file-controls">
                    <button id="export-json-btn" title="Save Setup"><i class="fa-solid fa-download"></i> Save JSON</button>
                    <label for="import-json-input" class="file-label" title="Load Setup"><i class="fa-solid fa-upload"></i> Load JSON
                        <input type="file" id="import-json-input" accept=".json">
                    </label>
                    <button id="export-csv-btn" title="Export All Data"><i class="fa-solid fa-file-csv"></i> CSV</button>
                </div>
            </div>
        </div>

        <!-- RIGHT PANEL: MAIN CONTENT -->
        <div id="main-panel">
            <header class="top-bar">
                <div class="view-tabs">
                    <button id="overview-tab-btn" class="view-tab-btn active"><i class="fa-solid fa-chart-pie"></i> Overview</button>
                    <button id="loss-tab-btn" class="view-tab-btn"><i class="fa-solid fa-arrow-trend-down"></i> Loss Analysis</button>
                    <button id="regression-tab-btn" class="view-tab-btn"><i class="fa-solid fa-chart-line"></i> Correlation (Regression)</button>
                </div>
                
                <!-- NEW GLOBAL DATE CONTROLS -->
                <div class="global-controls">
                    <div class="date-group">
                        <label>From</label>
                        <input type="date" id="start-date">
                    </div>
                    <div class="date-group">
                        <label>To</label>
                        <input type="date" id="end-date">
                    </div>
                    <button id="update-charts-btn" class="btn-primary small-btn"><i class="fa-solid fa-rotate"></i> Update</button>
                </div>
            </header>

            <div class="content-wrapper">
                
                <!-- VIEW 1: OVERVIEW -->
                <div id="overview-view" class="view-section">
                     <div class="dashboard-row">
                        <div class="card full-width">
                            <div class="card-header">
                                <h3>Hierarchy & Balance Overview</h3>
                                <div class="chart-controls">
                                    <label>Height:</label>
                                    <input type="number" id="org-chart-height-input" value="350" min="200" max="2000" step="50">
                                </div>
                            </div>
                            <div id="organization-chart" class="chart-container"></div>
                        </div>
                     </div>

                     <div class="card">
                        <div class="card-header">
                            <h3>Global Energy Flow (Sankey)</h3>
                            <div class="time-frame-selector">
                                <div class="date-group">
                                    <label>From</label>
                                    <input type="date" id="start-date">
                                </div>
                                <div class="date-group">
                                    <label>To</label>
                                    <input type="date" id="end-date">
                                </div>
                                <button id="update-charts-btn" class="btn-primary"><i class="fa-solid fa-rotate"></i> Update</button>
                            </div>
                        </div>
                        
                        <div class="chart-controls-bar">
                            <div class="control-item">
                                <label>Height (px)</label>
                                <input type="number" id="sankey-height-input" value="400" min="200" step="50">
                            </div>
                            <div class="control-item">
                                <label>Levels</label>
                                <input type="number" id="sankey-levels-input" value="0" min="0" max="10">
                            </div>
                            <div class="control-item checkbox-item">
                                <input type="checkbox" id="sankey-percentage-toggle">
                                <label for="sankey-percentage-toggle">Show %</label>
                            </div>
                            <div class="control-item">
                                <label>Unit</label>
                                <select id="display-unit-selector">
                                    <option value="kWh">kWh</option>
                                    <option value="MWh">MWh</option>
                                </select>
                            </div>
                                <div class="button-group" style="margin-left: auto; display: flex; gap: 5px;">
                                    <button id="save-sankey-btn" class="btn-primary small-btn" title="Save current node positions">
                                        <i class="fa-solid fa-floppy-disk"></i> Save Layout
                                    </button>
                                    <button id="reset-sankey-btn" class="btn-secondary small-btn" title="Reset to auto-layout">
                                        <i class="fa-solid fa-rotate-left"></i> Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="sankey-chart" class="chart-container"></div>
                        
                        <div class="table-wrapper">
                            <h4>Hierarchical Energy Breakdown</h4>
                            <table id="analysis-table" class="styled-table">
                                <thead>
                                    <tr>
                                        <th>System Path</th>
                                        <th id="analysis-table-unit-header">Total Energy (kWh)</th>
                                        <th>% of Root</th>
                                        <th id="analysis-table-unattributed-header">Unattributed</th>
                                        <th>Configured Loss</th>
                                    </tr>
                                </thead>
                                <tbody id="analysis-table-body"></tbody>
                            </table>
                            <button id="export-unattributed-btn" class="btn-secondary small-btn" style="margin-top:10px;">Export Unattributed Data</button>
                        </div>
                    </div>
                </div>

                <!-- VIEW 2: LOSS ANALYSIS (NEW) -->
                <div id="loss-view" class="view-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <h3>Technical vs. Non-Technical Loss Analysis</h3>
                                <p class="subtitle">Comparison of recorded parent energy vs. aggregated child consumption.</p>
                            </div>
                            <!-- NEW EXPORT BUTTON -->
                            <button id="export-loss-btn" class="btn-secondary"><i class="fa-solid fa-file-export"></i> Export Report</button>
                        </div>
                        <div class="table-wrapper">
                            <table id="loss-analysis-table" class="styled-table">
                                <thead>
                                    <tr>
                                        <th>System Name</th>
                                        <th>Recorded Input (A)</th>
                                        <th>Measured Children (B)</th>
                                        <th>Est. Unmeasured (C)</th>
                                        <th>Tech. Loss (D)</th>
                                        <th>Unexplained</th>
                                        <th>Efficiency</th>
                                        <!-- NEW COLUMN -->
                                        <th style="width: 250px;">Comments</th>
                                    </tr>
                                </thead>
                                <tbody id="loss-analysis-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- VIEW 3: REGRESSION ANALYSIS -->
                <div id="regression-view" class="view-section hidden">
                     <div class="grid-2-col">
                         <div class="card">
                            <h3>Setup Correlation</h3>
                            <div class="form-group">
                                <label>Energy System (Dependent):</label>
                                <select id="regression-energy-select"></select>
                            </div>
                            <div class="form-group">
                                <label>Production Items (Independent):</label>
                                <div id="regression-production-checklist" class="checklist-container"></div>
                            </div>
                            <div class="time-frame-selector">
                                <div class="date-group"><label>From</label><input type="date" id="regression-start-date"></div>
                                <div class="date-group"><label>To</label><input type="date" id="regression-end-date"></div>
                            </div>
                            <div class="button-group" style="margin-top:15px;">
                                <button id="start-reset-analysis-btn" class="btn-primary">Start Analysis</button>
                                <button id="refine-analysis-btn" class="btn-accent hidden">Refine Model (Pass +1)</button>
                            </div>
                         </div>
                         <div class="card">
                            <h3>Dashboard</h3>
                            <div id="regression-dashboard-container">
                                <div class="placeholder-text empty-state">Run an analysis to see results.</div>
                            </div>
                         </div>
                    </div>
                </div>

                <!-- WELCOME / EMPTY STATE -->
                <div id="welcome-message" class="empty-state">
                    <i class="fa-solid fa-chart-simple big-icon"></i>
                    <h2>Welcome to EnergyTool</h2>
                    <p>Select a view above, or select an item from the sidebar to configure data.</p>
                </div>

                <!-- DETAILS PANEL (SLIDE OVER) -->
                <div id="details-panel" class="hidden">
                    <div class="details-header">
                        <h2 id="selected-node-name">Node Name</h2>
                        <button id="close-details-btn" class="icon-btn"><i class="fa-solid fa-times"></i></button>
                    </div>
                    
                    <div class="details-content">
                        <!-- CONFIG CARD -->
                        <div class="card">
                            <h3><i class="fa-solid fa-sliders"></i> Configuration</h3>
                            
                            <!-- Energy Specific Config -->
                            <div id="energy-config-options">
                                <div class="form-group">
                                    <label>System Type</label>
                                    <select id="type-selector">
                                        <option value="Electrical">Electrical</option>
                                        <option value="Heat">Heat (general)</option>
                                        <option value="Heating Oil">Heating Oil</option>
                                    </select>
                                </div>
                                <div id="electrical-options" class="metadata-options">
                                    <label>Energy Type</label>
                                    <select id="electrical-type">
                                        <option value="kWh/Tag">Wirkenergie (kWh/Tag)</option>
                                        <option value="kVAh/Tag">Scheinenergie (kVAh/Tag)</option>
                                        <option value="kVARh/Tag">Blindenergie (kVARh/Tag)</option>
                                    </select>
                                </div>
                                <div id="heatoil-options" class="metadata-options hidden">
                                    <label>kWh per Liter</label>
                                    <input type="number" id="heatoil-energy" value="10" step="0.1">
                                </div>

                                <!-- LOSS CONFIGURATION (WASTE STREAMS) -->
                                <hr>
                                <h4><i class="fa-solid fa-bolt"></i> Loss Definition</h4>
                                <p class="help-text">Define technical losses (e.g. transformer/cable loss).</p>
                                <div class="form-group">
                                    <label>Loss Model</label>
                                    <select id="loss-model-selector">
                                        <option value="none">None (Ideal)</option>
                                        <option value="percent">Percentage of Load (%)</option>
                                        <option value="quadratic">Quadratic Curve (Trafo)</option>
                                        <option value="fixed">Fixed Constant (kWh/day)</option>
                                    </select>
                                </div>
                                <div id="loss-param-container" class="hidden">
                                    <label id="loss-param-label">Value</label>
                                    <input type="number" id="loss-param-input" step="0.0001">
                                    <p id="loss-help-text" class="help-text"></p>
                                </div>

                                <!-- UNMEASURED CONSUMERS (VIRTUAL SUB-METERING) -->
                                <hr>
                                <h4><i class="fa-solid fa-ghost"></i> Unmeasured Consumers</h4>
                                <p class="help-text">Account for energy used by unmetered items (lighting, HVAC) to correct efficiency.</p>
                                <div class="form-group">
                                    <label>Estimation Method</label>
                                    <select id="unmeasured-model-selector">
                                        <option value="none">None</option>
                                        <option value="percent">Percentage of Input (%)</option>
                                        <option value="fixed">Fixed Value (kWh/day)</option>
                                    </select>
                                </div>
                                <div id="unmeasured-param-container" class="hidden">
                                    <label id="unmeasured-param-label">Value</label>
                                    <input type="number" id="unmeasured-param-input" step="0.1">
                                    <div class="form-group" style="margin-top:10px;">
                                        <label>Label (for Chart)</label>
                                        <input type="text" id="unmeasured-label-input" placeholder="e.g. Lighting & HVAC" value="Unmeasured">
                                    </div>
                                </div>

                                <hr>
                                <div id="production-linking-container">
                                    <label>Linked Production Lines</label>
                                    <div id="production-link-checklist" class="checklist-container"></div>
                                </div>
                            </div>

                            <!-- Production Specific Config -->
                            <div id="production-config-options" class="hidden">
                                <div class="form-group">
                                   <label>Production Unit</label>
                                   <input type="text" id="production-unit" value="units">
                               </div>
                           </div>
                        </div>

                        <!-- DATA INPUT CARD -->
                        <div class="card">
                            <h3><i class="fa-solid fa-paste"></i> Data Entry</h3>
                            <textarea id="data-input" rows="5" placeholder="DD/MM/YYYY [tab] value"></textarea>
                            <button id="process-data-btn" class="btn-primary full-width">Add Data</button>
                        </div>

                        <!-- DATA TABLE CARD -->
                        <div class="card">
                            <div class="card-header">
                                <h3>Recorded Data</h3>
                                <button id="export-single-csv-btn" class="icon-btn small-btn" title="Export CSV"><i class="fa-solid fa-download"></i></button>
                            </div>
                            <div id="data-table-container">
                                <table id="data-table" class="styled-table compact">
                                    <thead><tr><th>Date</th><th>Value</th><th></th></tr></thead>
                                    <tbody id="data-table-body"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- CHARTS CARD -->
                        <div class="card">
                            <h3>Visualization</h3>
                            <div id="usage-chart" class="chart-container small"></div>
                            <h4 id="attribution-title">Breakdown</h4>
                            <div id="attribution-chart" class="chart-container small"></div>
                            <div id="stacked-area-chart" class="chart-container small"></div>
                            <div id="multi-line-chart" class="chart-container small"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="script.js"></script>
</body>
</html>