<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Consumption ML Predictor</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- SCRIPT ORDER IS CRITICAL -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://www.lactame.com/lib/ml/6.0.0/ml.min.js"></script>
</head>
<body>

    <div class="container">
        <header>
            <h1>Energy Consumption ML Predictor</h1>
            <p>Train an LSTM model to predict fuel consumption based on various measurements and time-based features.</p>
        </header>

        <main class="main-grid">
            <!-- ========== CONTROL PANEL ========== -->
            <div class="controls-panel">
                <section class="card data-input-section">
                    <h2>1. Define Features & Input Data</h2>
                    <div class="feature-definition">
                        <h3>Numerical Input Features:</h3>
                        <div id="numericalFeaturesContainer">
                            <!-- Dynamically populated -->
                        </div>
                        <button id="addNumericalFeature">Add Numerical Feature</button>
                        <p>Output Feature Name: <input type="text" id="outputFeatureName" value="Fuel_Consumption"></p>
                    </div>
                    
                    <h3>Consumer Disaggregation Rates:</h3>
                    <div id="consumerRatesContainer">
                        <!-- This content will be generated by script.js -->
                    </div>

                    <h3>Training Data:</h3>
                    <p>Format: <code>Date (YYYY-MM-DD HH:MM), Feat1, Feat2, ..., Output</code></p>
                    <textarea id="trainingData" rows="10" placeholder="e.g., 2025-01-01 00:00,20,60,100..."></textarea>
                    
                    <div>
                        <label for="trainingEpochs">Training Epochs:</label>
                        <input type="number" id="trainingEpochs" value="200" min="1" step="1" style="width: 120px;">
                    </div>
                    
                    <button id="trainModel">Train Model</button>
                    <p id="trainingStatus"></p>
                </section>
                
                <section class="card">
                    <h2>Rate Estimation Tool (via Linear Regression)</h2>
                    <p>Use this tool to get a data-driven suggestion for your rates. It finds the single best-fit intercept, which you can then distribute across your individual feature baselines.</p>
                    <button id="estimateRatesButton">Estimate Rates from Raw Data</button>
                    <button id="estimateRatesFromLstmButton">Estimate Rates from LSTM Predictions</button>
                    <div id="estimatedRatesResults" style="margin-top: 15px;"></div>
                </section>

                <section class="card feature-engineering-section">
                    <h2>2. Feature Engineering (Time-Based)</h2>
                    <p>Select time components to extract from the date as additional input features:</p>
                    <div class="time-features-selector">
                        <input type="checkbox" id="fe-year" value="year" checked><label for="fe-year">Year</label>
                        <input type="checkbox" id="fe-month" value="month" checked><label for="fe-month">Month</label>
                        <input type="checkbox" id="fe-day" value="day" checked><label for="fe-day">Day of Month</label>
                        <input type="checkbox" id="fe-dayofweek" value="dayofweek" checked><label for="fe-dayofweek">Day of Week</label>
                        <input type="checkbox" id="fe-hour" value="hour" checked><label for="fe-hour">Hour</label>
                        <input type="checkbox" id="fe-minute" value="minute"><label for="fe-minute">Minute</label>
                    </div>
                </section>

                <div class="model-interaction-grid">
                    <section class="card model-management-section">
                        <h2>3. Model Management</h2>
                        <button id="exportModel">Export Model</button>
                        <p>Import Model:</p>
                        <label for="modelJsonFile">Model JSON (.json):</label><input type="file" id="modelJsonFile" accept=".json">
                        <label for="weightsBinFile">Weights BIN (.bin):</label><input type="file" id="weightsBinFile" accept=".bin">
                        <label for="configJsonFile">Config JSON (.json):</label><input type="file" id="configJsonFile" accept=".json">
                        <button id="importModel">Import Model</button>
                        <p id="modelStatus"></p>
                    </section>

                    <section class="card prediction-section">
                        <h2>4. Make Prediction</h2>
                        <p>Enter values for the input features and select a prediction date/time.</p>
                        <div id="predictionInputsContainer"></div>
                        <label for="predictionDateTime">Prediction Date/Time:</label><input type="datetime-local" id="predictionDateTime">
                        <button id="predict">Predict</button>
                        <p id="predictionResult"></p>
                    </section>

                    <section class="card scenario-simulation-section">
                        <h2>5. Scenario Simulation</h2>
                        <p>Simulate output by varying one feature while others are fixed.</p>
                        <label for="featureToVarySelect">Feature to Vary:</label><select id="featureToVarySelect"></select>
                        <div class="range-inputs">
                            <label for="varyStart">Start Value:</label><input type="number" id="varyStart" value="0">
                            <label for="varyEnd">End Value:</label><input type="number" id="varyEnd" value="100">
                            <label for="varySteps">Number of Steps:</label><input type="number" id="varySteps" value="20" min="2">
                        </div>
                        <h3>Fixed Values for Other Features:</h3>
                        <div id="fixedFeatureInputsContainer"></div>
                        <button id="resetFixedValues">Reset Fixed Values to Averages</button>
                        <button id="runScenarioSimulation">Run Scenario Simulation</button>
                        <button id="exportSimulationCsv">Export Simulation Data as CSV</button>
                    </section>
                </div>
            </div>

            <!-- ========== CHART DISPLAY ========== -->
            <div class="chart-container card">
                <section class="analysis-section">
                    <h2>Model Performance Analysis</h2>
                    <div id="trainingFitChart"></div>
                    
                    <div id="performanceMetrics">
                        <h4>
                            LSTM Model Performance
                            <span class="tooltip-icon" title="Metrics for the advanced LSTM Neural Network model.">?</span>
                        </h4>
                        <p>
                            <strong>Training MSE:</strong> <span id="lstm-mseValue">N/A</span>
                            <span class="tooltip-icon" title="Mean Squared Error: The average of the squared differences between the predicted and actual values. Lower is better.">?</span>
                        </p>
                        <p>
                            <strong>Training R-squared:</strong> <span id="lstm-rSquaredValue">N/A</span>
                            <span class="tooltip-icon" title="R-squared: The percentage of the output's variation that is explained by the model. Higher (closer to 1.0) is better.">?</span>
                        </p>
                        <p>
                            <strong>Max % Error:</strong> <span id="lstm-max-error">N/A</span>%
                             <span class="tooltip-icon" title="The largest single percentage difference between a predicted value and its actual value. Indicates the worst-case error.">?</span>
                        </p>
                        <p>
                            <strong>Total vs Actual:</strong> <span id="lstm-total-comparison">N/A</span>%
                             <span class="tooltip-icon" title="Compares the sum of all predicted values to the sum of all actual values. A value near 100% means the model is well-balanced overall.">?</span>
                        </p>
                    
                        <h4>
                            Manual Rate Model Performance
                            <span class="tooltip-icon" title="Performance of the model based on the Rate and Baseline values you entered manually.">?</span>
                        </h4>
                        <p><strong>Training MSE:</strong> <span id="manual-mseValue">N/A</span></p>
                        <p><strong>Training R-squared:</strong> <span id="manual-rSquaredValue">N/A</span></p>
                        <p><strong>Max % Error:</strong> <span id="manual-max-error">N/A</span>%</p>
                        <p><strong>Total vs Actual:</strong> <span id="manual-total-comparison">N/A</span>%</p>
                    </div>

                    <h3>Total Consumption Breakdown (Pie Chart)</h3>
                    <p>Percentage contribution of each consumer to the total predicted consumption over the entire training period, based on the manual rate model.</p>
                    <div id="consumptionPieChart"></div>

                    <h3>Disaggregated Consumption Over Time (Stacked Chart)</h3>
                    <p>Shows how the manual rate model's predicted consumption is broken down by each consumer over time.</p>
                    <div id="disaggregatedTimeSeriesChart"></div>
                    <!-- ========== ADDED THIS BUTTON ========== -->
                    <button id="exportDisaggregationCsv">Export Disaggregation Data as CSV</button>
                    
                    <h3>Feature Sensitivity Analysis</h3>
                    <p>Select a feature to see its impact on prediction:</p>
                    <select id="sensitivityFeatureSelect"></select>
                    <button id="runSensitivityAnalysis">Run Analysis</button>
                    <div id="sensitivityChart"></div>

                    <h3>Scenario Simulation Results</h3>
                    <div id="scenarioSimulationChart"></div>
                    <div id="scenarioDisaggregationResults"></div>

                </section>
            </div>
        </main>
    </div>

    <script src="script.js"></script>
</body>
</html>
